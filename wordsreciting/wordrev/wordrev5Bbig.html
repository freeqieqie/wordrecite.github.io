<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>阅读类单词快训 - 双人PK版</title>
    <style>
        body {
            font-family: 'Comic Sans MS', cursive;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: flex-start;
            min-height: 100vh;
            margin: 0;
            padding-top: 20px;
            background-color: #E3EDCD;
        }
        
        /* 添加分屏容器样式 */
        .splitscreen-container {
            display: flex;
            justify-content: space-between;
            width: 98%;
            max-width: 1800px;
            margin: 0 auto;
        }
        
        /* 左右训练区域样式 */
        .training-area {
            width: 49%;
            border: 2px solid #97c1a9;
            border-radius: 10px;
            padding: 15px;
            box-sizing: border-box;
            background-color: rgba(255, 255, 255, 0.5);
        }
        
        /* 分隔区域样式 */
        .divider {
            width: 2px;
            background-color: #2c6e49;
        }
        
        /* 共享区域样式（标题和单元按钮）*/
        .shared-area {
            width: 100%;
            max-width: 1800px;
            margin-bottom: 20px;
        }

        .word-container {
            font-size: 48px;
            margin: 20px 0;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px dashed #97c1a9;
        }
        
        .word-wrong {
            color: red;
            font-weight: bold;
            font-size: 60px;
        }
        
        .word-normal {
            color: black;
            font-weight: normal;
            font-size: 48px;
            transition: all 0.3s ease;
        }
        
        /* 添加提示信息的样式 */
        .prompt-text {
            font-size: 36px; /* 比普通单词(48px)小一些的字体 */
            color: #2c6e49;
            font-weight: normal;
        }
        
        .options-container {
            display: flex;
            gap: 20px;
            justify-content: center;
        }
        
        .option-button {
            font-size: 24px;
            padding: 15px 30px;
            border: none;
            border-radius: 15px;
            background-color: #ffd1dc;
            cursor: pointer;
            transition: transform 0.2s;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation; /* 提高触摸响应 */
        }
        
        .option-button:hover {
            transform: scale(1.1);
            background-color: #ffb6c1;
        }
        
        .option-button:active {
            transform: scale(1.0);
            background-color: #ffd1dc;
        }
        
        .score-container {
            display: flex;
            gap: 15px;
            font-size: 16px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        #timer-left, #timer-right, 
        #score-left, #score-right, 
        #wordCount-left, #wordCount-right {
            font-weight: normal;
        }
        
        .unit-buttons {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            max-width: 90%;
            margin-left: auto;
            margin-right: auto;
        }
        
        .unit-button {
            font-size: 18px;
            padding: 10px 20px;
            border: none;
            border-radius: 10px;
            background-color: #ddd;
            cursor: pointer;
            transition: all 0.3s;
            margin: 0;
        }
        
        .unit-button.active {
            background-color: #97c1a9;
            color: white;
        }
        
        .grade-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 20px;
            color: #2c6e49;
            text-align: center;
        }
        
        .player-title {
            font-size: 22px;
            font-weight: bold;
            color: #2c6e49;
            text-align: center;
            margin-bottom: 10px;
            border-bottom: 2px solid #97c1a9;
            padding-bottom: 5px;
        }
        
        .records-section {
            width: 95%;
            margin: 10px auto;
        }
        
        .records-header {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 5px;
            gap: 15px;
        }
        
        .records-title {
            font-size: 16px;
            font-weight: bold;
            color: #2c6e49;
        }
        
        .records-count {
            font-size: 16px;
            font-weight: bold;
            color: #2c6e49;
        }
        
        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 5px;
            font-size: 14px;
        }
        
        .records-table th, .records-table td {
            border: 1px solid #ccc;
            padding: 6px;
            text-align: center;
        }
        
        .records-table th {
            background-color: #97c1a9;
            color: white;
        }
        
        .records-table tr:nth-child(even) {
            background-color: #f2f2f2;
        }
        
        .no-records {
            text-align: center;
            color: #666;
            font-style: italic;
            padding: 10px;
        }
        
        /* 针对大屏幕优化 */
        @media screen and (min-width: 1200px) {
            .splitscreen-container {
                width: 95%;
            }
            
            .option-button {
                font-size: 28px;
                padding: 18px 35px;
            }
            
            .word-container {
                font-size: 60px;
                height: 100px;
            }
            
            .word-normal {
                font-size: 60px;
            }
            
            .word-wrong {
                font-size: 72px;
            }
            
            .prompt-text {
                font-size: 45px;
            }
        }
    </style>
</head>
<body>
    <!-- 共享区域：标题和单元按钮 -->
    <div class="shared-area">
        <div class="grade-title">五下阅读类词汇训练 - 双人PK版</div>
        <div class="unit-buttons">
            <button class="unit-button" data-unit="1">Unit 1</button>
            <button class="unit-button" data-unit="2">Unit 2</button>
            <button class="unit-button" data-unit="3">Unit 3</button>
            <button class="unit-button" data-unit="4">Unit 4</button>
            <button class="unit-button" data-unit="5">Unit 5</button>
            <button class="unit-button" data-unit="6">Unit 6</button>
        </div>
    </div>
    
    <!-- 分屏容器 -->
    <div class="splitscreen-container">
        <!-- 左侧训练区域 -->
        <div class="training-area" id="area-left">
            <div class="player-title">玩家一</div>
            
            <div class="word-section">
                <div class="word-container" id="word-left">请选择训练单元</div>
            </div>
            
            <div class="options-section">
                <div class="options-container">
                    <button class="option-button" id="optionA-left">选项A</button>
                    <button class="option-button" id="optionB-left">选项B</button>
                </div>
                <div class="score-container">
                    <div id="timer-left">时间: 00:00</div>
                    <div id="score-left">得分: 0</div>
                    <div id="wordCount-left">进度: 0/0</div>
                </div>
            </div>
            
            <div class="records-section">
                <div class="records-header">
                    <div class="records-title">玩家一记录</div>
                    <div class="records-count" id="recordsCount-left">最佳记录：0条</div>
                </div>
                <table class="records-table">
                    <thead>
                        <tr>
                            <th>水平等级</th>
                            <th>完成用时</th>
                            <th>得分</th>
                            <th>总词汇数</th>
                        </tr>
                    </thead>
                    <tbody id="recordsBody-left">
                        <tr class="no-records">
                            <td colspan="4">暂无记录</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- 分隔线 -->
        <div class="divider"></div>
        
        <!-- 右侧训练区域 -->
        <div class="training-area" id="area-right">
            <div class="player-title">玩家二</div>
            
            <div class="word-section">
                <div class="word-container" id="word-right">请选择训练单元</div>
            </div>
            
            <div class="options-section">
                <div class="options-container">
                    <button class="option-button" id="optionA-right">选项A</button>
                    <button class="option-button" id="optionB-right">选项B</button>
                </div>
                <div class="score-container">
                    <div id="timer-right">时间: 00:00</div>
                    <div id="score-right">得分: 0</div>
                    <div id="wordCount-right">进度: 0/0</div>
                </div>
            </div>
            
            <div class="records-section">
                <div class="records-header">
                    <div class="records-title">玩家二记录</div>
                    <div class="records-count" id="recordsCount-right">最佳记录：0条</div>
                </div>
                <table class="records-table">
                    <thead>
                        <tr>
                            <th>水平等级</th>
                            <th>完成用时</th>
                            <th>得分</th>
                            <th>总词汇数</th>
                        </tr>
                    </thead>
                    <tbody id="recordsBody-right">
                        <tr class="no-records">
                            <td colspan="4">暂无记录</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const wordsByUnit = {
            1: {
                'eat breakfast': '吃早饭', 
                'have … class': '上……课', 
                'play sports': '进行体育运动', 
                'exercise': '活动；运动',
                'do morning exercises': '做早操', 
                'eat dinner': '吃晚饭', 
                'clean my room': '打扫我的房间', 
                'go for a walk': '散步',
                'go shopping': '去买东西；购物', 
                'take': '学习；上（课）', 
                'dancing': '跳舞；舞蹈', 
                'take a dancing class': '上舞蹈课',
                'when': '什么时候；何时', 
                'after': '在（时间）后', 
                'start': '开始', 
                'usually': '通常地；惯常地',
                'Spain': '西班牙', 
                'late': '晚；迟', 
                'a.m.': '午前；上午', 
                'p.m.': '午后；下午',
                'why': '为什么', 
                'shop': '去买东西；购物', 
                'work': '工作', 
                'last': '上一个的；刚过去的',
                'sound': '听起来好像', 
                'also': '还；也', 
                'busy': '忙的', 
                'need': '需要',
                'play': '戏剧；剧本', 
                'letter': '信', 
                'live': '居住', 
                'island': '岛',
                'always': '总是；一直', 
                'cave': '山洞；洞穴', 
                'win': '获胜'
            },
            2: {
                'spring': '春天', 
                'summer': '夏天', 
                'autumn': '秋天', 
                'winter': '冬天',
                'season': '季节', 
                'picnic': '野餐', 
                'go on a picnic': '去野餐', 
                'pick': '摘；采集',
                'pick apples': '摘苹果', 
                'snowman': '雪人', 
                'make a snowman': '堆雪人', 
                'go swimming': '去游泳',
                'which': '哪一个', 
                'best': '最，最高程度地', 
                'snow': '雪', 
                'good job': '做得好',
                'because': '因为', 
                'vacation': '假期', 
                'all': '全；完全', 
                'pink': '粉色；粉色的',
                'lovely': '可爱的；美丽的', 
                'leaf': '叶子（复数leaves）', 
                'fall': '落下；【美】秋天', 
                'paint': '用颜料绘画'
            },
            3: {
                'January': '一月', 
                'February': '二月', 
                'March': '三月', 
                'April': '四月',
                'May': '五月', 
                'June': '六月', 
                'July': '七月', 
                'August': '八月',
                'September': '九月', 
                'October': '十月', 
                'November': '十一月', 
                'December': '十二月',
                'year': '年', 
                'plant': '种植', 
                'contest': '比赛；竞赛', 
                'few': '一些',
                'a few': '一些', 
                'thing': '事情', 
                'meet': '集会；开会', 
                'sports meet': '运动会',
                'Easter': '复活节', 
                'trip': '旅行', 
                'national': '国家的', 
                'National Day': '国庆日',
                'American': '美国的', 
                'Thanksgiving': '感恩节', 
                'Christmas': '圣诞节', 
                'the Great Wall': '长城',
                'holiday': '假日；节日', 
                'game': '游戏', 
                'roll': '滚动', 
                'look for': '寻找',
                'chocolate': '巧克力', 
                'bunny': '（用作儿语）兔子', 
                'RSVP': '（尤用于请柬）请赐复', 
                'by': '在……之前'
            },
            4: {
                'first': '第一（的）', 
                'second': '第二（的）', 
                'third': '第三（的）', 
                'fourth': '第四（的）',
                'fifth': '第五（的）', 
                'twelfth': '第十二（的）', 
                'twentieth': '第二十（的）', 
                'twenty-first': '第二十一（的）',
                'twenty-third': '第二十三（的）', 
                'thirtieth': '第三十（的）', 
                'fool': '蠢人；傻瓜', 
                'special': '特殊的；特别的',
                'kitten': '小猫', 
                'diary': '日记', 
                'still': '仍然；依旧；还是', 
                'noise': '声音；响声；噪音',
                'fur': '（某些动物的）浓密的软毛', 
                'open': '开着的', 
                'walk': '行走'
            },
            5: {
                'mine': '我的', 
                'yours': '你（们）的', 
                'his': '他的', 
                'hers': '她的',
                'theirs': '他们的；她们的；它们的', 
                'ours': '我们的', 
                'climbing': '（正在）攀登；攀爬', 
                'eating': '（正在）吃',
                'playing': '（正在）玩耍', 
                'jumping': '（正在）跳', 
                'drinking': '（正在）喝（水）', 
                'sleeping': '（正在）睡觉',
                'each': '每一；各个', 
                'other': '其他', 
                'each other': '相互', 
                'excited': '兴奋的；激动的',
                'like': '像……那样'
            },
            6: {
                'doing morning exercises': '（正在）做早操', 
                'having... class': '（正在）上……课', 
                'eating lunch': '（正在）吃午饭', 
                'reading a book': '（正在）看书',
                'listening to music': '（正在）听音乐', 
                'keep': '保持某种状态', 
                'keep to the right': '靠右', 
                'keep your desk clean': '保持你的课桌整洁',
                'talk quietly': '小声讲话', 
                'turn': '顺序', 
                'take turns': '按顺序来', 
                'bamboo': '竹子',
                'its': '它的', 
                'show': '给人看；指引', 
                'anything': '任何事物', 
                'else': '另外；其他',
                'exhibition': '展览', 
                'say': '说；讲', 
                'have a look': '看一看', 
                'sushi': '寿司',
                'teach': '教', 
                'sure': '（表示同意）当然', 
                'Canadian': '加拿大的', 
                'Spanish': '西班牙的'
            }
        };

        // 确保正确设置记录键名，以指向三年级下大全的记录
        const recordKey = 'wordrev5Bbig_records'; // 修改为正确的记录键名

        // 创建玩家状态对象，封装每个玩家的数据和状态
        function createPlayerState(side) {
            return {
                activeUnits: new Set(),
                words: {},
                completedWords: new Set(),
                score: 0,
                currentWord: '',
                correctAnswer: '',
                answeredWrong: false,
                timerInterval: null,
                startTime: null,
                timerStarted: false,
                todayRecords: [],
                currentDate: '',
                
                // 各元素的ID
                elements: {
                    word: document.getElementById(`word-${side}`),
                    optionA: document.getElementById(`optionA-${side}`),
                    optionB: document.getElementById(`optionB-${side}`),
                    timer: document.getElementById(`timer-${side}`),
                    score: document.getElementById(`score-${side}`),
                    wordCount: document.getElementById(`wordCount-${side}`),
                    recordsCount: document.getElementById(`recordsCount-${side}`),
                    recordsBody: document.getElementById(`recordsBody-${side}`)
                },
                
                // 本地存储键 - 为每个年级添加专属标识
                storage: {
                    records: `wordRev5BBig_Records-${side}`,
                    date: `wordRev5BBig_RecordsDate-${side}`
                }
            };
        }
        
        // 创建两个玩家的状态
        const playerLeft = createPlayerState('left');
        const playerRight = createPlayerState('right');
        
        // 初始化样式
        playerLeft.elements.word.classList.add('prompt-text');
        playerRight.elements.word.classList.add('prompt-text');
        
        // 初始化并检查日期变化
        function initRecords(player) {
            const today = new Date().toLocaleDateString();
            
            // 从本地存储获取记录
            const savedRecords = localStorage.getItem(player.storage.records);
            const savedDate = localStorage.getItem(player.storage.date);
            
            // 如果日期变了，清空记录
            if (savedDate !== today) {
                player.todayRecords = [];
                localStorage.setItem(player.storage.date, today);
                localStorage.setItem(player.storage.records, JSON.stringify(player.todayRecords));
            } else if (savedRecords) {
                // 否则加载已保存的记录
                player.todayRecords = JSON.parse(savedRecords);
                // 加载后立即对记录进行排序，并只保留前5名
                sortRecords(player);
                // 重新保存筛选后的记录
                localStorage.setItem(player.storage.records, JSON.stringify(player.todayRecords));
            }
            
            player.currentDate = today;
            updateRecordsDisplay(player);
        }
        
        // 添加计算等级的函数
        function calculateRank(score, duration, totalWords) {
            // 转换duration为秒数
            const durationSeconds = convertDurationToSeconds(duration);
            
            // 1. 得分小于总词汇数，为青铜
            if (score < totalWords) {
                return "青铜";
            }
            
            // 2. 得分=总词汇数时，根据用时评定等级
            // 计算王者时间（总词汇数*1.5秒，向下取整）
            const kingTime = Math.floor(totalWords * 1.5);
            
            // 如果用时小于等于王者时间，为王者或更高
            if (durationSeconds <= kingTime) {
                // 计算星级
                const starDiff = kingTime - durationSeconds;
                if (starDiff === 0) {
                    return "王者";
                } else {
                    return `王者${starDiff}星`;
                }
            }
            
            // 计算超出王者时间的秒数
            const overTime = durationSeconds - kingTime;
            
            // 根据超出秒数划分等级
            if (overTime <= 10) {
                // 星耀等级：61-70秒
                return overTime <= 5 ? "星耀2阶" : "星耀1阶";
            } else if (overTime <= 20) {
                // 钻石等级：71-80秒
                return overTime <= 15 ? "钻石2阶" : "钻石1阶";
            } else if (overTime <= 30) {
                // 铂金等级：81-90秒
                return overTime <= 25 ? "铂金2阶" : "铂金1阶";
            } else if (overTime <= 40) {
                // 黄金等级：91-100秒
                return overTime <= 35 ? "黄金2阶" : "黄金1阶";
            } else {
                // 超过100秒，白银等级
                return "白银";
            }
        }
        
        // 添加获取等级图标路径函数
        function getRankIconPath(rank) {
            let iconName = '';
            
            if (rank.includes('王者')) {
                iconName = '07wangzhe';
            } else if (rank.includes('星耀')) {
                iconName = '06xingyao';
            } else if (rank.includes('钻石')) {
                iconName = '05zuanshi';
            } else if (rank.includes('铂金')) {
                iconName = '04bojin';
            } else if (rank.includes('黄金')) {
                iconName = '03huangjin';
            } else if (rank === '白银') {
                iconName = '02baiyin';
            } else { // 青铜
                iconName = '01qingtong';
            }
            
            return `./pics/rank/${iconName}.png`;
        }
        
        // 更新记录显示
        function updateRecordsDisplay(player) {
            const tbody = player.elements.recordsBody;
            const countElement = player.elements.recordsCount;
            
            // 更新记录数量显示，改为显示最佳记录数
            countElement.textContent = `最佳记录：${player.todayRecords.length}条`;
            
            // 清空现有内容
            tbody.innerHTML = '';
            
            if (player.todayRecords.length === 0) {
                const row = document.createElement('tr');
                row.className = 'no-records';
                row.innerHTML = '<td colspan="4">暂无记录</td>';
                tbody.appendChild(row);
                return;
            }
            
            // 添加每条记录
            player.todayRecords.forEach((record, index) => {
                const rank = calculateRank(record.score, record.duration, record.totalWords);
                const iconPath = getRankIconPath(rank);
                const row = document.createElement('tr');
                // 为排名前三的记录添加特殊样式
                if (index < 3) {
                    row.style.fontWeight = 'bold';
                    // 前三名使用不同的背景色
                    const colors = ['#e7ff00', '#d0e600', '#a2b300']; // 金、银、铜
                    row.style.backgroundColor = colors[index];
                    row.style.color = index === 0 ? '#000' : '#000';
                }
                row.innerHTML = `
                    <td><img src="${iconPath}" class="rank-icon" alt="${rank}" style="width:24px;height:24px;vertical-align:middle;"> <span style="font-style:normal;">${rank}</span></td>
                    <td>${record.duration}</td>
                    <td>${record.score}</td>
                    <td>${record.totalWords} ${record.unitsString ? `(${record.unitsString})` : ''}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // 添加新的完成记录
        function addCompletionRecord(player, duration, score, totalWords) {
            const now = new Date();
            const dateTimeString = now.toLocaleString();
            
            // 收集激活的单元信息
            const activeUnitsArray = Array.from(activeUnits).sort((a, b) => a - b);
            const unitsString = activeUnitsArray.map(unit => `U${unit}`).join('');
            
            const record = {
                dateTime: dateTimeString,
                duration: duration,
                score: score,
                totalWords: totalWords,
                units: activeUnitsArray, // 保存单元数组
                unitsString: unitsString, // 保存格式化的单元字符串
                timestamp: new Date().getTime()
            };
            
            player.todayRecords.push(record);
            
            // 添加记录后立即排序，并只保留前5名
            sortRecords(player);
            
            // 保存到本地存储
            localStorage.setItem(player.storage.records, JSON.stringify(player.todayRecords));
            
            // 更新显示
            updateRecordsDisplay(player);
        }
        
        // 获取等级的数值大小，用于排序（数值越小等级越高）
        function getRankValue(rank) {
            if (rank.includes('王者')) {
                // 王者N星比王者高
                if (rank === '王者') {
                    return 10;
                } else {
                    // 提取星数，星数越多等级越高，数值越小
                    const stars = parseInt(rank.replace('王者', '').replace('星', ''));
                    return 10 - stars;
                }
            } else if (rank.includes('星耀')) {
                return rank.includes('2阶') ? 20 : 21; // 2阶比1阶高
            } else if (rank.includes('钻石')) {
                return rank.includes('2阶') ? 30 : 31;
            } else if (rank.includes('铂金')) {
                return rank.includes('2阶') ? 40 : 41;
            } else if (rank.includes('黄金')) {
                return rank.includes('2阶') ? 50 : 51;
            } else if (rank === '白银') {
                return 60;
            } else { // 青铜
                return 70;
            }
        }
        
        // 添加排序函数
        function sortRecords(player) {
            // 首先给所有记录计算等级值
            player.todayRecords.forEach(record => {
                record.rankValue = getRankValue(
                    calculateRank(record.score, record.duration, record.totalWords)
                );
            });
            
            player.todayRecords.sort((a, b) => {
                // 首先按等级从高到低排序
                if (a.rankValue !== b.rankValue) {
                    return a.rankValue - b.rankValue; // 注意：等级值越小代表等级越高
                }
                
                // 如果等级相同，再按得分从高到低排序
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                
                // 如果得分也相同，则按用时从短到长排序
                const durationA = convertDurationToSeconds(a.duration);
                const durationB = convertDurationToSeconds(b.duration);
                return durationA - durationB;
            });
            
            // 只保留排序后的前5名记录
            if (player.todayRecords.length > 5) {
                player.todayRecords = player.todayRecords.slice(0, 5);
            }
        }
        
        // 将时间格式（mm:ss）转换为秒数的辅助函数
        function convertDurationToSeconds(duration) {
            const parts = duration.split(':');
            return parseInt(parts[0]) * 60 + parseInt(parts[1]);
        }
        
        // 格式化持续时间（从秒到mm:ss格式）
        function formatDuration(seconds) {
            const minutes = Math.floor(seconds / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            return `${minutes}:${secs}`;
        }

        // 计时器相关函数
        function startTimer(player) {
            if (player.timerStarted) return; // 如果已经开始计时，不再重新开始
            
            player.timerStarted = true;
            player.startTime = new Date();
            player.timerInterval = setInterval(() => updateTimer(player), 1000);
            updateTimer(player); // 立即更新一次，避免延迟
        }

        function stopTimer(player) {
            if (player.timerInterval) {
                clearInterval(player.timerInterval);
                player.timerInterval = null;
            }
        }

        function resetTimer(player) {
            stopTimer(player);
            player.timerStarted = false;
            player.elements.timer.textContent = '时间: 00:00';
        }

        function updateTimer(player) {
            if (!player.startTime) return;
            
            const now = new Date();
            const diff = Math.floor((now - player.startTime) / 1000); // 秒数差
            
            const minutes = Math.floor(diff / 60).toString().padStart(2, '0');
            const seconds = (diff % 60).toString().padStart(2, '0');
            
            player.elements.timer.textContent = `时间: ${minutes}:${seconds}`;
        }

        function updateActiveWords(player) {
            player.words = {};
            player.completedWords.clear(); // 切换单元时重置已完成单词
            resetTimer(player); // 重置计时器
            player.score = 0; // 在这里重置得分，即选择新单元时
            player.elements.score.textContent = `得分: ${player.score}`;
            
            activeUnits.forEach(unit => {
                if (wordsByUnit[unit]) {
                    Object.assign(player.words, wordsByUnit[unit]);
                }
            });
            
            const totalWords = Object.keys(player.words).length;
            updateProgress(player, 0, totalWords);
            
            if (totalWords === 0) {
                player.elements.word.textContent = '请选择训练单元';
                player.elements.word.classList.add('prompt-text');
                player.elements.word.classList.remove('word-normal');
                return false;
            }
            return true;
        }

        function updateProgress(player, completed, total) {
            player.elements.wordCount.textContent = `进度: ${completed}/${total}`;
        }

        function getRandomWord(player) {
            const availableWords = Object.keys(player.words).filter(word => 
                !player.completedWords.has(word));
            
            if (availableWords.length === 0) {
                // 首先更新进度显示为完成状态
                const totalWords = Object.keys(player.words).length;
                updateProgress(player, totalWords, totalWords);
                
                // 停止计时器并计算完成用时
                stopTimer(player);
                let completionDuration = "00:00";
                if (player.startTime) {
                    const endTime = new Date();
                    const durationInSeconds = Math.floor((endTime - player.startTime) / 1000);
                    completionDuration = formatDuration(durationInSeconds);
                }
                
                // 记录完成情况
                addCompletionRecord(player, completionDuration, player.score, totalWords);
                
                // 计算等级
                const rank = calculateRank(player.score, completionDuration, totalWords);
                const iconPath = getRankIconPath(rank);
                
                // 显示训练结束的提示文本，包括等级信息和图标 - 同一行显示
                player.elements.word.innerHTML = `
                    <div style="display:flex;align-items:center;justify-content:center;">
                        <div>您获得了 <span style="font-weight:bold;color:#2c6e49;">${rank}</span> 等级</div>
                        <img src="${iconPath}" alt="${rank}" style="width:48px;height:48px;margin-left:10px;">
                    </div>
                `;
                player.elements.word.classList.add('prompt-text');
                player.elements.word.classList.remove('word-normal');
                
                // 重置选项按钮为默认文本
                player.elements.optionA.textContent = "选项A";
                player.elements.optionB.textContent = "选项B";
                
                // 清空已完成单词集合方便重新训练，但保留得分
                player.completedWords.clear();
                
                // 返回空字符串，不会显示出来
                return "";
            }
            
            const randomWord = availableWords[Math.floor(Math.random() * availableWords.length)];
            // 播放单词发音
            playAudio(randomWord);
            return randomWord;
        }

        function getRandomMeaning(player, excludeMeaning) {
            const meaningsList = Object.values(player.words);
            let randomMeaning;
            do {
                randomMeaning = meaningsList[Math.floor(Math.random() * meaningsList.length)];
            } while (randomMeaning === excludeMeaning); // 确保不会选到要排除的意思
            return randomMeaning;
        }

        function newQuestion(player) {
            if (Object.keys(player.words).length === 0) {
                return;
            }
            
            player.currentWord = getRandomWord(player);
            
            // 如果是空字符串，表示训练已结束，不进行后续处理
            if (player.currentWord === "") {
                return;
            }
            
            player.correctAnswer = player.words[player.currentWord];
            player.answeredWrong = false; // 重置答错标记
            
            const wordElement = player.elements.word;
            // 准备显示单词
            wordElement.classList.remove('prompt-text');
            wordElement.classList.add('word-normal');
            wordElement.textContent = player.currentWord;

            const isCorrectFirst = Math.random() < 0.5;
            const wrongAnswer = getRandomMeaning(player, player.correctAnswer); // 传入正确答案作为排除项

            player.elements.optionA.textContent = isCorrectFirst ? player.correctAnswer : wrongAnswer;
            player.elements.optionB.textContent = isCorrectFirst ? wrongAnswer : player.correctAnswer;
        }

        function checkAnswer(player, selectedAnswer) {
            // 第一次选择答案时开始计时
            if (!player.timerStarted) {
                startTimer(player);
            }
            
            const wordElement = player.elements.word;
            
            // 如果单词当前处于错误状态（红色显示），不执行任何操作直接返回
            if (wordElement.classList.contains('word-wrong')) {
                return;
            }
            
            if (selectedAnswer === player.correctAnswer) {
                if (!player.answeredWrong) {
                    player.score += 1;
                    player.elements.score.textContent = `得分: ${player.score}`;
                }
                player.completedWords.add(player.currentWord); // 添加到已完成集合
                updateProgress(player, player.completedWords.size, Object.keys(player.words).length);
                
                // 重置按钮样式
                player.elements.optionA.blur();
                player.elements.optionB.blur();
                
                // 进入下一个问题
                newQuestion(player);
            } else {
                player.answeredWrong = true; // 标记已答错
                wordElement.classList.remove('word-normal');
                wordElement.classList.add('word-wrong');
                
                // 重置按钮焦点
                player.elements.optionA.blur();
                player.elements.optionB.blur();
                
                setTimeout(() => {
                    wordElement.classList.remove('word-wrong');
                    wordElement.classList.add('word-normal');
                }, 1000);
            }
        }
        
        // 添加播放音频的函数
        function playAudio(word) {
            const audio = new Audio(`https://dict.youdao.com/dictvoice?audio=${word}&type=1`);
            audio.play().catch(error => console.error('Error playing audio:', error));
        }
        
        // 更新记录保存函数
        function saveTrainingRecord() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (!loggedInUser) return;
            
            const userData = JSON.parse(loggedInUser);
            const username = userData.username;
            
            // 构建记录对象
            const record = {
                date: new Date().toLocaleDateString(),
                timeUsed: seconds,
                timeDisplay: formatTime(seconds),
                correctWords: correctCount,
                totalWords: totalQuestions,
                timestamp: new Date().getTime()
            };
            
            // 获取所有记录，不再根据日期清除旧记录
            let allRecords = JSON.parse(localStorage.getItem(`${username}_${recordKey}`) || '[]');
            
            // 添加新记录
            allRecords.push(record);
            
            // 按规则排序：一次性全对数量（降序）→训练用时（升序）→日期（降序）
            allRecords.sort((a, b) => {
                if (a.correctWords !== b.correctWords) {
                    return b.correctWords - a.correctWords; // 全对数量降序
                }
                if (a.timeUsed !== b.timeUsed) {
                    return a.timeUsed - b.timeUsed; // 用时升序
                }
                return b.timestamp - a.timestamp; // 日期降序
            });
            
            // 限制记录总数以避免localStorage溢出
            const MAX_RECORDS = 100; // 每个用户最多保存100条记录
            if (allRecords.length > MAX_RECORDS) {
                allRecords = allRecords.slice(-MAX_RECORDS);
            }
            
            // 保存回localStorage
            localStorage.setItem(`${username}_${recordKey}`, JSON.stringify(allRecords));
            
            // 确保更新显示
            displayTrainingRecords();
        }

        // 修改显示训练记录函数，只显示今天的记录
        function displayTrainingRecords() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (!loggedInUser) return;
            
            const userData = JSON.parse(loggedInUser);
            const username = userData.username;
            
            // 获取所有记录
            const allRecords = JSON.parse(localStorage.getItem(`${username}_${recordKey}`) || '[]');
            
            // 获取今天的日期
            const today = new Date().toLocaleDateString();
            
            // 筛选今天的记录
            const todayRecords = allRecords.filter(record => record.date === today);
            
            // 获取表格主体
            const tableBody = document.getElementById('recordsTableBody');
            tableBody.innerHTML = '';
            
            // 填充记录
            todayRecords.forEach(record => {
                const row = document.createElement('tr');
                
                const dateCell = document.createElement('td');
                dateCell.textContent = record.date;
                
                const timeCell = document.createElement('td');
                timeCell.textContent = record.timeDisplay;
                
                const correctCell = document.createElement('td');
                correctCell.textContent = `${record.correctWords}/${record.totalWords}`;
                
                const percentCell = document.createElement('td');
                const percent = Math.round((record.correctWords / record.totalWords) * 100);
                percentCell.textContent = `${percent}%`;
                
                row.appendChild(dateCell);
                row.appendChild(timeCell);
                row.appendChild(correctCell);
                row.appendChild(percentCell);
                
                tableBody.appendChild(row);
            });
        }

        // 添加格式化时间显示函数
        function formatTime(totalSeconds) {
            const minutes = Math.floor(totalSeconds / 60);
            const seconds = totalSeconds % 60;
            return `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // 添加日期变化检测，以便在跨天时更新显示
        document.addEventListener('DOMContentLoaded', function() {
            // ...existing code...
            
            // 添加时间变化检测，每分钟检查一次是否跨天
            setInterval(checkDateChange, 60000); // 每分钟检查一次
        });

        // 检查日期变化的函数
        let lastCheckedDate = new Date().toLocaleDateString();
        function checkDateChange() {
            const currentDate = new Date().toLocaleDateString();
            if (currentDate !== lastCheckedDate) {
                // 日期已变化，更新界面显示
                lastCheckedDate = currentDate;
                displayTrainingRecords(); // 重新加载今天的记录
            }
        }

        // 共享单元状态，两边都用同一个单元配置
        let activeUnits = new Set();
        
        // 初始化单元按钮事件监听
        document.querySelectorAll('.unit-button').forEach(button => {
            button.addEventListener('click', () => {
                const unit = parseInt(button.dataset.unit);
                if (!wordsByUnit[unit]) {
                    alert('该单元暂时没有单词');
                    return;
                }
                
                button.classList.toggle('active');
                if (activeUnits.has(unit)) {
                    activeUnits.delete(unit);
                } else {
                    activeUnits.add(unit);
                }
                
                // 为两个玩家更新单词
                const leftHasWords = updateActiveWords(playerLeft);
                const rightHasWords = updateActiveWords(playerRight);
                
                // 如果有足够的单词，为两个玩家开始新问题
                if (leftHasWords) {
                    newQuestion(playerLeft);
                }
                
                if (rightHasWords) {
                    newQuestion(playerRight);
                }
            });
        });

        // 初始化玩家左侧选项按钮事件监听
        playerLeft.elements.optionA.addEventListener('click', function() {
            checkAnswer(playerLeft, this.textContent);
        });
        
        playerLeft.elements.optionB.addEventListener('click', function() {
            checkAnswer(playerLeft, this.textContent);
        });
        
        // 初始化玩家右侧选项按钮事件监听
        playerRight.elements.optionA.addEventListener('click', function() {
            checkAnswer(playerRight, this.textContent);
        });
        
        playerRight.elements.optionB.addEventListener('click', function() {
            checkAnswer(playerRight, this.textContent);
        });

        // 添加触摸事件支持
        document.addEventListener('DOMContentLoaded', function() {
            // 左侧玩家触摸事件
            playerLeft.elements.optionA.addEventListener('touchend', function(e) {
                e.preventDefault(); // 防止默认行为
                checkAnswer(playerLeft, this.textContent);
                this.blur();
            });
            
            playerLeft.elements.optionB.addEventListener('touchend', function(e) {
                e.preventDefault();
                checkAnswer(playerLeft, this.textContent);
                this.blur();
            });
            
            // 右侧玩家触摸事件
            playerRight.elements.optionA.addEventListener('touchend', function(e) {
                e.preventDefault();
                checkAnswer(playerRight, this.textContent);
                this.blur();
            });
            
            playerRight.elements.optionB.addEventListener('touchend', function(e) {
                e.preventDefault();
                checkAnswer(playerRight, this.textContent);
                this.blur();
            });
            
            // 初始化记录
            initRecords(playerLeft);
            initRecords(playerRight);
        });
    </script>
</body>
</html>


